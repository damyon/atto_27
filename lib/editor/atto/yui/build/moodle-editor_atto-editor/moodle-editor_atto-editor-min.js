YUI.add("moodle-editor_atto-editor",function(e,t){function i(){var e=this.getHTML(),t=[{regex:/<!--[\s\S]*?-->/gi,replace:""},{regex:/<\\?\?xml[^>]*>/gi,replace:""},{regex:/<\/?\w+:[^>]*>/gi,replace:""},{regex:/\s*MSO[-:][^;"']*;?/gi,replace:""},{regex:/<span[^>]*>(&nbsp;|\s)*<\/span>/gi,replace:""},{regex:/class="Mso[^"]*"/gi,replace:""},{regex:/<(\/?title|\/?meta|\/?style|\/?st\d|\/?head|\/?font|\/?html|\/?body|!\[)[^>]*?>/gi,replace:""},{regex:new RegExp(String.fromCharCode(8220),"gi"),replace:'"'},{regex:new RegExp(String.fromCharCode(8216),"gi"),replace:"'"},{regex:new RegExp(String.fromCharCode(8217),"gi"),replace:"'"},{regex:new RegExp(String.fromCharCode(8211),"gi"),replace:"-"},{regex:new RegExp(String.fromCharCode(8212),"gi"),replace:"--"},{regex:new RegExp(String.fromCharCode(189),"gi"),replace:"1/2"},{regex:new RegExp(String.fromCharCode(188),"gi"),replace:"1/4"},{regex:new RegExp(String.fromCharCode(190),"gi"),replace:"3/4"},{regex:new RegExp(String.fromCharCode(169),"gi"),replace:"(c)"},{regex:new RegExp(String.fromCharCode(174),"gi"),replace:"(r)"},{regex:new RegExp(String.fromCharCode(8230),"gi"),replace:"..."}],n=0,r;for(n=0;n<t.length;n++)r=t[n],e=e.replace(r.regex,r.replace);return this.setHTML(e),this}CSS={CONTENT:"editor_atto_content",CONTENTWRAPPER:"editor_atto_content_wrap",TOOLBAR:"editor_atto_toolbar",WRAPPER:"editor_atto"},M.editor_atto=M.editor_atto||{BLOCK_TAGS:["address","article","aside","audio","blockquote","canvas","dd","div","dl","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","noscript","ol","output","p","pre","section","table","tfoot","ul","video"],buttonhandlers:{},textupdatedhandlers:{},menus:{},menuhandlers:{},filepickeroptions:{},widgets:{},selections:{},focusfromclick:!1,showhide_menu_handler:function(t){t.preventDefault();var n=this.getAttribute("disabled"),r=this.getAttribute("data-menu"),i=M.editor_atto.menus[r],s=i.get("bodyContent");if(i.get("visible")||n)i.hide(),s.detach("clickoutside");else{s.on("clickoutside",function(e){e.target.ancestor()!==this&&e.target!==this&&i.get("visible")&&(s.detach("clickoutside"),i.hide())},this),i.align(e.one(e.config.doc.body),[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]),i.show();var o=t.target.ancestor("button",!0).one("img");i.align(o,[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]),i.get("boundingBox").one("a").focus()}},buttonclicked_handler:function(t){var n=this.getAttribute("data-editor"),r=this.getAttribute("data-plugin"),i=this.getAttribute("data-handler"),s=M.editor_atto.menus[r+"_"+n],o=M.editor_atto.get_toolbar_node(n),u=o.getAttribute("aria-activedescendant");u&&(current=e.one("#"+u),current.setAttribute("tabindex","-1")),this.setAttribute("tabindex",0),o.setAttribute("aria-activedescendant",this.generateID()),s&&s.hide();if(M.editor_atto.is_enabled(n,r))return i=M.editor_atto.buttonhandlers[i],i(t,n)},disable_all_widgets:function(e){var t,n,r=M.editor_atto.get_toolbar_node(e);for(t in M.editor_atto.widgets)n=r.one(".atto_"+t+"_button"),n&&n.setAttribute("disabled","true")},get_textarea_node:function(t){return e.one(document.getElementById(t))},get_toolbar_node:function(t){return e.one(document.getElementById(t+"_toolbar"))},get_editable_node:function(t){return e.one(document.getElementById(t+"editable"))},is_enabled:function(e,t){var n=M.editor_atto.get_toolbar_node(e).one(".atto_"+t+"_button");return!n.hasAttribute("disabled")},enable_widget:function(e,t){var n=M.editor_atto.get_toolbar_node(e).one(".atto_"+t+"_button");n&&n.removeAttribute("disabled")},enable_all_widgets:function(e){var t,n;for(t in M.editor_atto.widgets)n=M.editor_atto.get_toolbar_node(e).one(".atto_"+t+"_button"),n&&n.removeAttribute("disabled")},add_text_updated_handler:function(e,t){e in M.editor_atto.textupdatedhandlers||(M.editor_atto.textupdatedhandlers[e]=[]),M.editor_atto.textupdatedhandlers[e].push(t)},add_toolbar_menu:function(t,n,r,i,s,o,u){var a=M.editor_atto.get_toolbar_node(t),f=a.one(".atto_group."+i+"_group"),l,c,h;typeof o=="undefined"&&(o="14"),typeof u=="undefined"&&(u="transparent"),f||(f=e.Node.create('<div class="atto_group '+i+'_group"></div>'),a.append(f)),h=M.util.image_url("t/expanded","moodle"),c=e.Node.create('<button class="atto_'+n+'_button atto_hasmenu" '+'data-editor="'+e.Escape.html(t)+'" '+'tabindex="-1" '+'type="button" '+'data-menu="'+n+"_"+t+'" '+'title="'+e.Escape.html(M.util.get_string("pluginname","atto_"+n))+'">'+'<img class="icon" aria-hidden="true" role="presentation" width="16" height="16" '+'style="background-color:'+u+';" src="'+r+'"/>'+'<img class="icon" aria-hidden="true" role="presentation" width="16" height="16" src="'+h+'"/>'+"</button>"),f.append(c),l=a.getAttribute("aria-activedescendant"),l||(c.setAttribute("tabindex","0"),a.setAttribute("aria-activedescendant",c.generateID())),M.editor_atto.widgets[n]=n;var p=e.Node.create('<div class="atto_'+n+"_menu"+' atto_menu" data-editor="'+e.Escape.html(t)+'"'+' style="min-width:'+(o-2)+'em"'+'"></div>'),d=0,v={};for(d=0;d<s.length;d++)v=s[d],p.append(e.Node.create('<div class="atto_menuentry"><a href="#" class="atto_'+n+"_action_"+d+'" '+'data-editor="'+e.Escape.html(t)+'" '+'data-plugin="'+e.Escape.html(n)+'" '+'data-handler="'+e.Escape.html(n+"_action_"+d)+'">'+v.text+"</a>"+"</div>")),M.editor_atto.buttonhandlers[n+"_action_"+d]||(e.one("body").delegate("click",M.editor_atto.buttonclicked_handler,".atto_"+n+"_action_"+d),e.one("body").delegate("key",M.editor_atto.buttonclicked_handler,"space,enter",".atto_"+n+"_action_"+d),M.editor_atto.buttonhandlers[n+"_action_"+d]=v.handler);M.editor_atto.buttonhandlers[n]||(e.one("body").delegate("click",M.editor_atto.showhide_menu_handler,".atto_"+n+"_button"),M.editor_atto.buttonhandlers[n]=!0);var m=new M.core.dialogue({bodyContent:p,visible:!1,width:o+"em",lightbox:!1,closeButton:!1,center:!1});M.editor_atto.menus[n+"_"+t]=m,m.align(c,[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]),m.hide(),m.headerNode.hide(),m.render
()},add_toolbar_button:function(t,n,r,i,s){var o=M.editor_atto.get_toolbar_node(t),u=o.one(".atto_group."+i+"_group"),a,f;u||(u=e.Node.create('<div class="atto_group '+i+'_group"></div>'),o.append(u)),a=e.Node.create('<button class="atto_'+n+'_button" '+'data-editor="'+e.Escape.html(t)+'" '+'data-plugin="'+e.Escape.html(n)+'" '+'tabindex="-1" '+'data-handler="'+e.Escape.html(n)+'" '+'title="'+e.Escape.html(M.util.get_string("pluginname","atto_"+n))+'">'+'<img class="icon" aria-hidden="true" role="presentation" width="16" height="16" src="'+r+'"/>'+"</button>"),u.append(a),f=o.getAttribute("aria-activedescendant"),f||(a.setAttribute("tabindex","0"),o.setAttribute("aria-activedescendant",a.generateID())),M.editor_atto.buttonhandlers[n]||(e.one("body").delegate("click",M.editor_atto.buttonclicked_handler,".atto_"+n+"_button"),M.editor_atto.buttonhandlers[n]=s),M.editor_atto.widgets[n]=n},is_active:function(t){var n=M.editor_atto.get_selection();n.length&&(n=n.pop());var r=null;n.parentElement?r=e.one(n.parentElement()):r=e.one(n.startContainer);var i=M.editor_atto.get_editable_node(t);return r&&i.contains(r)},focus:function(e){M.editor_atto.get_editable_node(e).focus()},init:function(t){var n=e.Node.create('<div class="'+CSS.WRAPPER+'" />'),r=e.Node.create('<div id="'+t.elementid+'editable" '+'contenteditable="true" '+'role="textbox" '+'spellcheck="true" '+'aria-live="off" '+'class="'+CSS.CONTENT+'" />'),i=e.Node.create('<div class="'+CSS.TOOLBAR+'" id="'+t.elementid+'_toolbar" role="toolbar" aria-live="off"/>'),s=e.Node.create('<div class="'+CSS.CONTENTWRAPPER+'" />'),o=M.editor_atto.get_textarea_node(t.elementid),u=e.one('[for="'+t.elementid+'"]');u&&(u.generateID(),r.setAttribute("aria-labelledby",u.get("id")),i.setAttribute("aria-labelledby",u.get("id"))),s.appendChild(r),n.appendChild(i),n.appendChild(s),r.setStyle("minHeight",1.2*o.getAttribute("rows")+"em"),r.append(o.get("value")),r.cleanHTML(),o.get("parentNode").insert(n,o);try{document.execCommand("styleWithCSS",0,!1)}catch(a){try{document.execCommand("useCSS",0,!0)}catch(f){try{document.execCommand("styleWithCSS",!1,!1)}catch(l){}}}o.hide(),this.publish_events(),r.on("atto:selectionchanged",this.save_selection,this,t.elementid),r.on("focus",this.restore_selection,this,t.elementid),r.on("mousedown",function(){this.focusfromclick=!0},this),r.on("blur",function(){this.focusfromclick=!1,this.text_updated(t.elementid)},this),e.one(e.config.doc.body).delegate("key",this.keyboard_navigation,"down:37,39","#"+t.elementid+"_toolbar",this,t.elementid),M.editor_atto.filepickeroptions[t.elementid]=t.filepickeroptions;var c,h,p,d;for(c=0;c<t.plugins.length;c++){p=t.plugins[c].group;for(h=0;h<t.plugins[c].plugins.length;h++)d=t.plugins[c].plugins[h],d.params.elementid=t.elementid,d.params.group=p,M["atto_"+d.name].init(d.params)}for(c=0;c<t.plugins.length;c++){p=t.plugins[c].group;for(h=0;h<t.plugins[c].plugins.length;h++)d=t.plugins[c].plugins[h],d.params.elementid=t.elementid,d.params.group=p,typeof M["atto_"+d.name].after_init!="undefined"&&M["atto_"+d.name].after_init(d.params)}},publish_events:function(){e.Event.define("atto:selectionchanged",{changeHandler:function(e,t){var n=t.sub.node.getAttribute("id");n=n.substring(0,n.length-8),e.elementid=n,e.selectedNodes=M.editor_atto.get_selected_nodes(n),e.selection=M.editor_atto.get_selection(),t.notifier.fire(e)},on:function(t,n,r){var i={notifier:r,sub:n};n.attoKeyDownDetach=t.on("keydown",e.throttle(this.changeHandler),this,i),n.attoMouseUpDetach=t.on("mouseup",e.throttle(this.changeHandler),this,i),n.attoFocusDetach=t.on("focus",e.throttle(this.changeHandler),this,i)},detach:function(e,t){t.attoKeyDownDetach.detach(),t.attoMouseUpDetach.detach(),t.attoFocusDetach.detach()},delegate:function(t,n,r,i){var s={notifier:r,sub:n};n.attoKeyDownDetachDelegate=t.delegate("keydown",e.throttle(this.changeHandler),i,this,s),n.attoMouseUpDetachDelegate=t.delegate("mouseup",e.throttle(this.changeHandler),i,this,s),n.attoFocusDetachDelegate=t.delegate("focus",e.throttle(this.changeHandler),i,this,s)},detachDelegate:function(e,t){t.attoKeyDownDetachDelegate.detach(),t.attoMouseUpDetachDelegate.detach(),t.attoFocusDetachDelegate.detach()}})},text_updated:function(e){var t=M.editor_atto.get_textarea_node(e),n=this.get_clean_html(e);t.set("value",n),t.simulate("change");var r=0;if(e in M.editor_atto.textupdatedhandlers)for(r=0;r<M.editor_atto.textupdatedhandlers[e].length;r++){var i=M.editor_atto.textupdatedhandlers[e][r];i(e)}},get_clean_html:function(t){var n=M.editor_atto.get_editable_node(t).cloneNode(!0);return e.each(n.all("[id]"),function(e){var t=e.get("id");t.indexOf("yui")===0&&e.removeAttribute("id")}),n.cleanHTML(),n.getHTML()},keyboard_navigation:function(t,n){var r,i,s,o,u=M.editor_atto.get_toolbar_node(n);t.preventDefault(),r=u.all("empty"),u.all(".atto_group").each(function(e){e.hasAttribute("hidden")||(r=r.concat(e.all("button")))}),s=u.getAttribute("aria-activedescendant");if(!s)return;i=e.one("#"+s),i.setAttribute("tabindex","-1"),o=r.indexOf(i),t.keyCode===37?(o--,o<0&&(o=r.size()-1)):(o++,o>=r.size()&&(o=0)),i=r.item(o),i.setAttribute("tabindex","0"),i.focus(),u.setAttribute("aria-activedescendant",i.generateID())},can_show_filepicker:function(e,t){var n=M.editor_atto.filepickeroptions[e];return typeof n[t]!="undefined"},show_filepicker:function(t,n,r){e.use("core_filepicker",function(e){var i=M.editor_atto.filepickeroptions[t][n];i.formcallback=r,M.core_filepicker.show(e,i)})},get_selection_from_node:function(e){var t;return window.getSelection?(t=document.createRange(),t.setStartBefore(e.getDOMNode()),t.setEndAfter(e.getDOMNode()),[t]):document.selection?(t=document.body.createTextRange(),t.moveToElementText(e.getDOMNode()),t):!1},save_selection:function(e,t){if(this.is_active(t)){var n=this.get_selection();n.length>0&&(this.selections[t]=n)}},restore_selection:function(e,t){e.preventDefault(),this.focusfromclick||typeof this.selections[t]!="undefined"&&this.set_selection(this.selections
[t]),this.focusfromclick=!1},get_selection:function(){if(window.getSelection){var e=window.getSelection(),t=[],n=0;for(n=0;n<e.rangeCount;n++)t.push(e.getRangeAt(n));return t}return document.selection&&document.selection.createRange?document.selection.createRange():!1},selection_contains_node:function(e){var t,n;if(window.getSelection){n=window.getSelection();if(n.containsNode)return n.containsNode(e.getDOMNode(),!0)}return n=document.selection.createRange(),t=n.duplicate(),t.moveToElementText(e.getDOMNode()),n.inRange(t)},selection_filter_matches:function(e,t,n){var r=!0;return n||(n=M.editor_atto.get_selected_nodes(e)),t="."+CSS.CONTENT+" "+t,n.size()===0?!1:(n.each(function(e){e.ancestor(t,!0)||(r=!1)}),r)},selection_filter:function(t,n){var r=M.editor_atto.get_selected_nodes(t),i=new e.NodeList;return n="."+CSS.CONTENT+" "+n,r.each(function(e){e.ancestors(n,!0).each(function(e){i.indexOf(e)===-1&&i.push(e)})}),i},get_selected_nodes:function(t){var n=M.editor_atto.get_editable_node(t),r=M.editor_atto.get_selection_start_container(),i=M.editor_atto.get_selection_end_container(),s=new e.NodeList,o=!1;if(!r||!i)return s;var u=function(e,t,i,s){if(t===e){if(t!==e||r!==e||!!o||!e.hasChildNodes())return e.hasChildNodes()||s.push(e),!1;o=!0}if(e.hasChildNodes()){var a=e.get("childNodes"),f=a.item(i);if(f)return u(f,t,0,s)}else s.push(e);if(e===n)return!1;var l=e.ancestor(),c=l.get("childNodes").indexOf(e);return u(l,t,c+1,s)};return u(r,i,0,s),s},get_selection_start_container:function(){var t=M.editor_atto.get_selection();t.length&&(t=t.pop());if(t.startContainer)return e.one(t.startContainer);if(t.parentElement){var n=t.duplicate();return n.collapse(!0),e.one(n.parentElement())}},get_selection_end_container:function(){var t=M.editor_atto.get_selection();t.length&&(t=t.pop());if(t.endContainer)return e.one(t.endContainer);if(t.parentElement){var n=t.duplicate();return n.collapse(!1),e.one(n.parentElement())}return!1},get_selection_parent_node:function(){var e=M.editor_atto.get_selection();return e.length&&(e=e.pop()),e.commonAncestorContainer?e.commonAncestorContainer:e.parentElement?e.parentElement():!1},get_selection_text:function(){var e=M.editor_atto.get_selection();if(e.length>0&&e[0].cloneContents)return e[0].cloneContents()},set_selection:function(e){var t,n;if(window.getSelection){t=window.getSelection(),t.removeAllRanges();for(n=0;n<e.length;n++)t.addRange(e[n])}else document.selection&&e.select&&e.select()},format_selection_block:function(t,n,r){var i=M.editor_atto.get_selection_parent_node(),s,o,u,a,f,l;if(!i)return;s=M.editor_atto.get_editable_node(t),i=e.one(i),o=i.ancestor(function(e){var t=e.get("tagName");return t&&(t=t.toLowerCase()),e===s||t==="td"||t==="th"},!0),o&&(s=o),u=i.ancestor(M.editor_atto.BLOCK_TAGS.join(", "),!0),u&&(f=u.ancestor(function(e){return e===s},!1),f||(u=!1)),u||(a=e.Node.create("<p></p>"),s.get("childNodes").each(function(e){a.append(e.remove())}),s.append(a),u=a),n&&n!==""&&(l=e.Node.create("<"+n+"></"+n+">"),l.setAttrs(u.getAttrs()),u.get("childNodes").each(function(e){e.remove(),l.append(e)}),u.replace(l),u=l),r&&u.setAttrs(r);var c=M.editor_atto.get_selection_from_node(u);return M.editor_atto.set_selection(c),u}};var n="Controlmenu",r;r=function(e){e.draggable=!1,e.center=!1,e.width="auto",e.lightbox=!1,e.footerContent="",e.hideOn=[{eventName:"clickoutside"}],r.superclass.constructor.apply(this,[e])},e.extend(r,M.core.dialogue,{initializer:function(t){var n,i,s;r.superclass.initializer.call(this,t),s=this.get("boundingBox"),s.addClass("editor_atto_controlmenu"),n=this.bodyNode,i=e.Node.create("<h3/>"),i.addClass("accesshide"),i.setHTML(this.get("headerText")),n.prepend(i)}},{NAME:n,ATTRS:{headerText:{value:""}}}),M.editor_atto=M.editor_atto||{},M.editor_atto.controlmenu=r,e.Node.addMethod("cleanHTML",i),e.NodeList.importMethod(e.Node.prototype,"cleanHTML")},"@VERSION@",{requires:["node","io","overlay","escape","event","event-simulate","event-custom","yui-throttle","moodle-core-notification"]});
